var e=require("ethjs-provider-http"),r=require("ethjs-query"),t=require("ethjs-contract"),n=require("ethr-did-resolver/contracts/ethr-did-registry.json"),o=require("did-jwt"),i=o.createJWT,s=o.verifyJWT,a=o.SimpleSigner,c=o.toEthereumAddress,u=require("buffer").Buffer,h=require("ethr-did-resolver"),d=h.REGISTRY,v=h.stringToBytes32,p=h.delegateTypes,m=new(0,require("elliptic").ec)("secp256k1"),y=p.Secp256k1VerificationKey2018,f=require("web3"),g=require("ethereumjs-tx").Transaction,l=require("ethereumjs-common");function P(e,r){if(u.isBuffer(r))return"0x"+r.toString("hex");var t=e.match(/^did\/(pub|auth|svc)\/(\w+)(\/(\w+))?(\/(\w+))?$/);return t&&"base64"===t[6]?"0x"+u.from(r,"base64").toString("hex"):r.match(/^0x[0-9a-fA-F]*$/)?r:"0x"+u.from(r).toString("hex")}var w=function(o){void 0===o&&(o={});var i=function(r){return void 0===r&&(r={}),r.provider?r.provider:r.web3?r.web3.currentProvider:new e(r.rpcUrl||"https://mainnet.infura.io/ethr-did")}(o),s=new r(i),c=o.registry||d,u=new t(s)(n);if(this.registry=u.at(c),this.address=o.address,this.registryAddress=c,this.web3Provider=new f.providers.HttpProvider(o.providerUrl),this.web3=new f(this.web3Provider),this.privateKey=o.privateKey,this.chainId=o.chainId,this.networkId=o.networkId,this.registryInstance=new this.web3.eth.Contract(n,c),!this.address)throw new Error("No address is set for EthrDid");this.did="did:ethr:"+this.address,o.signer?this.signer=o.signer:o.privateKey&&(this.signer=a(o.privateKey))};w.prototype.createKeyPair=function(){try{var e=m.genKeyPair(),r=e.getPublic("hex"),t=e.getPrivate("hex"),n=c(r);return Promise.resolve({address:n,privateKey:t})}catch(e){return Promise.reject(e)}},w.prototype.getAccountNonce=function(e){try{return Promise.resolve(this.web3.eth.getTransactionCount(e))}catch(e){return Promise.reject(e)}},w.prototype.estimateGas=function(e,r){for(var t=[],n=arguments.length-2;n-- >0;)t[n]=arguments[n+2];try{return Promise.resolve(e.apply(void 0,t).estimateGas({from:r}))}catch(e){return Promise.reject(e)}},w.prototype.getGasPrice=function(){try{return Promise.resolve(this.web3.eth.getGasPrice())}catch(e){return Promise.reject(e)}},w.prototype.toHex=function(e){try{return Promise.resolve(this.web3.utils.toHex(e))}catch(e){return Promise.reject(e)}},w.prototype.getData=function(e){for(var r=[],t=arguments.length-1;t-- >0;)r[t]=arguments[t+1];try{return Promise.resolve(e.apply(void 0,r).encodeABI())}catch(e){return Promise.reject(e)}},w.prototype.sendRawTransaction=function(e){try{return Promise.resolve(this.web3.eth.sendSignedTransaction(""+e.toString("hex")))}catch(e){return Promise.reject(e)}},w.prototype.signTransaction=function(e,r,t,n,o,i){try{var s=this,a=u.from(s.privateKey,"hex");return Promise.resolve(s.toHex(e)).then(function(e){return Promise.resolve(s.toHex(i)).then(function(i){return Promise.resolve(s.toHex(o)).then(function(o){return Promise.resolve(s.toHex(t)).then(function(t){var c={nonce:e,gasPrice:i,gasLimit:o,to:r,value:t,data:n},u=l.default.forCustomChain("mainnet",{name:"my-network",networkId:Number(s.networkId),chainId:Number(s.chainId)},"petersburg"),h=new g(c,{common:u});return h.sign(a),h.serialize()})})})})}catch(e){return Promise.reject(e)}},w.prototype.signAndSendTxRoot=function(e,r,t,n){for(var o=[],i=arguments.length-4;i-- >0;)o[i]=arguments[i+4];try{var s=this;return Promise.resolve(s.getGasPrice()).then(function(i){return Promise.resolve(s.estimateGas.apply(s,[t,e].concat(o))).then(function(a){return Promise.resolve(s.getData.apply(s,[t].concat(o))).then(function(t){return Promise.resolve(s.getAccountNonce(e)).then(function(e){return Promise.resolve(s.signTransaction(e,r,n,t,a,i)).then(function(e){return Promise.resolve(s.sendRawTransaction(e))})})})})})}catch(e){return Promise.reject(e)}},w.prototype.lookupOwner=function(e){void 0===e&&(e=!0);try{return e&&this.owner?Promise.resolve(this.owner):Promise.resolve(this.registryInstance.methods.identityOwner(this.address).call())}catch(e){return Promise.reject(e)}},w.prototype.changeOwner=function(e){try{var r=this;return Promise.resolve(r.lookupOwner()).then(function(t){return Promise.resolve(r.registry.changeOwner(r.address,e,{from:t})).then(function(t){return r.owner=e,t})})}catch(e){return Promise.reject(e)}},w.prototype.addDelegate=function(e,r){void 0===r&&(r={});try{var t=this,n=r.delegateType||y,o=r.expiresIn||86400;return Promise.resolve(t.lookupOwner()).then(function(r){return Promise.resolve(t.signAndSendTxRoot(r,t.registryAddress,t.registryInstance.methods.addDelegate,0,t.address,n,e,o))})}catch(e){return Promise.reject(e)}},w.prototype.revokeDelegate=function(e,r){void 0===r&&(r=y);try{var t=this;return Promise.resolve(t.lookupOwner()).then(function(n){return t.registry.revokeDelegate(t.address,r,e,{from:n})})}catch(e){return Promise.reject(e)}},w.prototype.setAttribute=function(e,r,t,n){void 0===t&&(t=86400);try{var o=this;return Promise.resolve(o.lookupOwner()).then(function(i){return o.registry.setAttribute(o.address,v(e),P(e,r),t,{from:i,gas:n})})}catch(e){return Promise.reject(e)}},w.prototype.revokeAttribute=function(e,r,t){try{var n=this;return Promise.resolve(n.lookupOwner()).then(function(o){return n.registry.revokeAttribute(n.address,v(e),P(e,r),{from:o,gas:t})})}catch(e){return Promise.reject(e)}},w.prototype.createSigningDelegate=function(e,r){void 0===e&&(e=y),void 0===r&&(r=86400);try{var t=w.createKeyPair();return this.signer=a(t.privateKey),Promise.resolve(this.addDelegate(t.address,{delegateType:e,expiresIn:r})).then(function(e){return{kp:t,txHash:e}})}catch(e){return Promise.reject(e)}},w.prototype.signJWT=function(e,r){try{if("function"!=typeof this.signer)throw new Error("No signer configured");var t={signer:this.signer,alg:"ES256K-R",issuer:this.did};return r&&(t.expiresIn=r),Promise.resolve(i(e,t))}catch(e){return Promise.reject(e)}},w.prototype.verifyJWT=function(e,r,t){try{return void 0===t&&(t=this.did),Promise.resolve(s(e,{resolver:r,audience:t}))}catch(e){return Promise.reject(e)}},module.exports=w;
//# sourceMappingURL=index.js.map
